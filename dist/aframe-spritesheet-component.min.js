!function(e){function t(r){if(a[r])return a[r].exports;var i=a[r]={i:r,l:!1,exports:{}};return e[r].call(i.exports,i,i.exports,t),i.l=!0,i.exports}var a={};return t.m=e,t.c=a,t.i=function(e){return e},t.d=function(e,a,r){t.o(e,a)||Object.defineProperty(e,a,{configurable:!1,enumerable:!0,get:r})},t.n=function(e){var a=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(a,"a",a),a},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=0)}([function(e,t,a){"use strict";function r(e){e--;for(var t=2;e>>=1;)t<<=1;return t}var i=AFRAME.registerComponent("sprite-sheet",{schema:{progress:{type:"number",default:0},cols:{type:"number",default:1},rows:{type:"number",default:1},firstFrame:{type:"number",default:0},lastFrame:{type:"number",default:null},cloneTexture:{default:!1},dataUrl:{type:"string",default:null}},init:function(){var e=this;console.log("init"),this.data.dataUrl?(this.mapCanvas=document.createElement("canvas"),this.textureCtx=this.mapCanvas.getContext("2d"),this.texture=new THREE.Texture(this.mapCanvas),this.getSpriteSheetData(this.data.dataUrl),this.el.addEventListener("materialtextureloaded",function(){e.imageLoaded=!0,e.spriteSheetImage=e.el.object3D.children[0].material.map.image,e.texture=new THREE.Texture(e.mapCanvas),e.el.object3D.children[0].material.map=e.texture})):(this.numFrames=this.data.rows*this.data.cols,this.el.addEventListener("materialtextureloaded",function(){e.imageLoaded=!0,e.data.cloneTexture&&(e.el.object3D.children[0].material.map=e.el.object3D.children[0].material.map.clone(),e.el.object3D.children[0].material.map.needsUpdate=!0),e.texture=e.el.object3D.children[0].material.map,e.texture.wrapS=e.texture.wrapT=THREE.RepeatWrapping,e.texture.repeat.set(e.texture.image.width/e.data.cols/e.texture.image.width,e.texture.image.height/e.data.rows/e.texture.image.height),e.update()})),this.currentFrame=0},update:function(){if(this.framesData||this.data.firstFrame!=this.data.lastFrame){var e=this.data.lastFrame?this.data.lastFrame:this.numFrames-1;this.currentFrame=Math.round(this.data.progress*(e-this.data.firstFrame))+this.data.firstFrame,this.adjustTexture(this.currentFrame)}},remove:function(){this.mapCanvas=null,this.textureCtx=null,this.texture=null,this.spriteSheetImage=null,this.spriteSheetData=null,this.framesData=null},getSpriteSheetData:function(e){var t=this,a=document.querySelector("a-assets");a?a.fileLoader.load(e,function(e){t.spriteSheetData=JSON.parse(e),t.framesData=Object.keys(t.spriteSheetData.frames).map(function(e){return t.spriteSheetData.frames[e]}),t.numFrames=t.framesData.length,t.frameWidth=t.framesData[0].sourceSize.w,t.frameHeight=t.framesData[0].sourceSize.h,t.mapCanvas.width=r(t.frameWidth),t.mapCanvas.height=r(t.frameHeight),t.texture.repeat.set(t.frameWidth/t.mapCanvas.width,t.frameHeight/t.mapCanvas.height),t.texture.offset.x=0,t.texture.offset.y=1-t.frameHeight/t.mapCanvas.height}):console.warn("Can't load spritesheet URL. No a-assets element present on the A-Scene!")},adjustTexture:function(e){console.log(e),this.imageLoaded&&this.lastDrawnFrame!=e&&(this.framesData?this.adjustFrameBySpriteSheet(e):this.adjustFrameByRowsCols(e),this.lastDrawnFrame=e)},adjustFrameByRowsCols:function(e){this.texture.offset.x=e%this.data.cols/this.data.cols,this.texture.offset.y=-1/this.data.rows-Math.floor(e/this.data.cols)/this.data.rows},adjustFrameBySpriteSheet:function(e){var t=this.framesData[e];if(this.textureCtx.clearRect(0,0,this.mapCanvas.width,this.mapCanvas.height),this.textureCtx.save(),t.rotated){var a={dX:this.frameHeight-(t.frame.h+t.spriteSourceSize.y),dY:t.spriteSourceSize.x,width:t.frame.h,height:t.frame.w};this.textureCtx.rotate(-90*Math.PI/180),this.textureCtx.translate(-this.frameHeight,0),this.textureCtx.drawImage(this.spriteSheetImage,t.frame.x,t.frame.y,t.frame.h,t.frame.w,a.dX,a.dY,a.width,a.height)}else{var r={dX:this.frameWidth/2+(t.spriteSourceSize.x-t.sourceSize.w/2),dY:this.frameHeight/2+(t.spriteSourceSize.y-t.sourceSize.h/2),width:t.frame.w,height:t.frame.h};this.textureCtx.drawImage(this.spriteSheetImage,t.frame.x,t.frame.y,t.frame.w,t.frame.h,r.dX,r.dY,r.width,r.height)}this.textureCtx.restore(),this.texture.needsUpdate=!0}});e.exports=i}]);